<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Test Member Count Implementation</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .method { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>メンバー数カウント実装テスト</h1>
    
    <div class="test-section">
        <h2>1. 各方法でのカウントテスト</h2>
        <button onclick="testAllMethods()">すべての方法をテスト</button>
        <div id="method-results"></div>
    </div>

    <div class="test-section">
        <h2>2. 統合テスト</h2>
        <button onclick="testIntegration()">統合テストを実行</button>
        <div id="integration-results"></div>
    </div>

    <div class="test-section">
        <h2>3. パフォーマンステスト</h2>
        <button onclick="testPerformance()">パフォーマンステスト</button>
        <div id="performance-results"></div>
    </div>

    <!-- Load all dashboard scripts -->
    <script src="js/supabase-client.js"></script>
    <script src="js/dashboard-data.js"></script>
    <script src="js/dashboard-data-fix.js"></script>
    <script src="js/dashboard-realtime-calculator.js"></script>
    <script src="js/dashboard-member-counter.js"></script>

    <script>
        function log(section, content, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = content;
            document.getElementById(`${section}-results`).appendChild(div);
        }

        async function testAllMethods() {
            const results = document.getElementById('method-results');
            results.innerHTML = '';
            
            const counter = window.dashboardMemberCounter;
            if (!counter) {
                log('method', 'dashboardMemberCounterが読み込まれていません', 'error');
                return;
            }

            // 各メソッドを個別にテスト
            const methods = [
                { name: 'profiles', func: () => counter.countFromProfiles() },
                { name: 'users', func: () => counter.countFromUsers() },
                { name: 'members', func: () => counter.countFromMembers() },
                { name: 'user_activities', func: () => counter.countFromActivities() },
                { name: 'dashboard_stats', func: () => counter.countFromDashboardStats() }
            ];

            for (const method of methods) {
                try {
                    const startTime = Date.now();
                    const count = await method.func();
                    const elapsed = Date.now() - startTime;
                    
                    if (count !== null) {
                        log('method', `
                            <div class="method success">
                                <strong>${method.name}テーブル</strong><br>
                                カウント: ${count}<br>
                                実行時間: ${elapsed}ms
                            </div>
                        `, 'success');
                    } else {
                        log('method', `
                            <div class="method warning">
                                <strong>${method.name}テーブル</strong><br>
                                利用不可または空
                            </div>
                        `, 'warning');
                    }
                } catch (error) {
                    log('method', `
                        <div class="method error">
                            <strong>${method.name}テーブル</strong><br>
                            エラー: ${error.message}
                        </div>
                    `, 'error');
                }
            }
        }

        async function testIntegration() {
            const results = document.getElementById('integration-results');
            results.innerHTML = '';
            
            try {
                // getTotalMembersメソッドをテスト
                log('integration', '<h3>getTotalMembers()メソッドのテスト</h3>', 'info');
                
                const startTime = Date.now();
                const totalMembers = await window.dashboardMemberCounter.getTotalMembers();
                const elapsed = Date.now() - startTime;
                
                log('integration', `
                    <div class="success">
                        総メンバー数: ${totalMembers}<br>
                        実行時間: ${elapsed}ms<br>
                        キャッシュ状態: ${window.dashboardMemberCounter.cache.count !== null ? 'あり' : 'なし'}
                    </div>
                `, 'success');
                
                // 成長率の計算
                const growthPercentage = window.dashboardMemberCounter.calculateGrowthPercentage(totalMembers);
                log('integration', `
                    <div class="info">
                        成長率: ${growthPercentage}%<br>
                        前回カウント: ${window.dashboardMemberCounter.previousCount}
                    </div>
                `, 'info');
                
                // ダッシュボード統計との統合テスト
                if (window.dashboardStats) {
                    const statsCount = await window.dashboardStats.calculateTotalMembers();
                    log('integration', `
                        <div class="info">
                        dashboardStats.calculateTotalMembers(): ${statsCount}
                        </div>
                    `, 'info');
                }
                
            } catch (error) {
                log('integration', `エラー: ${error.message}`, 'error');
            }
        }

        async function testPerformance() {
            const results = document.getElementById('performance-results');
            results.innerHTML = '';
            
            log('performance', '<h3>パフォーマンステスト（10回実行）</h3>', 'info');
            
            const times = [];
            
            // キャッシュをクリア
            window.dashboardMemberCounter.cache.count = null;
            
            for (let i = 0; i < 10; i++) {
                const startTime = Date.now();
                await window.dashboardMemberCounter.getTotalMembers();
                const elapsed = Date.now() - startTime;
                times.push(elapsed);
                
                log('performance', `実行 ${i + 1}: ${elapsed}ms ${i === 0 ? '(初回・キャッシュなし)' : '(キャッシュあり)'}`, 'info');
            }
            
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
            const minTime = Math.min(...times);
            const maxTime = Math.max(...times);
            
            log('performance', `
                <div class="success">
                    <h4>統計</h4>
                    平均実行時間: ${avgTime.toFixed(2)}ms<br>
                    最小実行時間: ${minTime}ms<br>
                    最大実行時間: ${maxTime}ms<br>
                    キャッシュ効果: ${((times[0] - avgTime) / times[0] * 100).toFixed(1)}%改善
                </div>
            `, 'success');
        }

        // 起動時に基本情報を表示
        window.addEventListener('supabaseReady', async () => {
            const info = document.createElement('div');
            info.className = 'test-section info';
            info.innerHTML = `
                <h3>システム情報</h3>
                <p>Supabase接続: ✅</p>
                <p>dashboardMemberCounter: ${window.dashboardMemberCounter ? '✅' : '❌'}</p>
                <p>キャッシュTTL: ${window.dashboardMemberCounter?.cache.ttl || 0}ms</p>
            `;
            document.body.insertBefore(info, document.body.firstChild);
        });
    </script>
</body>
</html>