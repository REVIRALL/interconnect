<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>コネクションテスト</title>
</head>
<body>
    <h1>コネクションデータテスト</h1>
    <div id="result"></div>
    <button onclick="window.location.href='login.html'">ログインページへ</button>
    <button onclick="window.location.href='connections.html'">コネクションページへ</button>
    
    <!-- 統一されたSupabaseクライアントを使用 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-unified.js"></script>
    <script src="js/error-prevention.js"></script>
    <script src="js/global-functions.js"></script>
    
    <script>
        
        async function testConnections() {
            const resultDiv = document.getElementById('result');
            
            try {
                // Supabaseクライアントを待つ
                await window.waitForSupabase();
                
                // 現在のユーザーを取得
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                if (!user) {
                    resultDiv.innerHTML = '<p>ログインしていません</p>';
                    return;
                }
                
                resultDiv.innerHTML += `<p>現在のユーザーID: ${user.id}</p>`;
                resultDiv.innerHTML += `<p>メール: ${user.email}</p>`;
                
                // connectionsテーブルの全データを取得
                const { data: allConnections, error } = await window.supabaseClient
                    .from('connections')
                    .select('*')
                    .or(`user_id.eq.${user.id},connected_user_id.eq.${user.id}`);
                
                if (error) {
                    resultDiv.innerHTML += `<p style="color: red;">エラー: ${error.message}</p>`;
                    console.error('エラー詳細:', error);
                    return;
                }
                
                resultDiv.innerHTML += `<h2>全コネクション数: ${allConnections ? allConnections.length : 0}</h2>`;
                
                if (allConnections && allConnections.length > 0) {
                    // ステータスごとに分類
                    const pending = allConnections.filter(c => c.status === 'pending');
                    const accepted = allConnections.filter(c => c.status === 'accepted');
                    const rejected = allConnections.filter(c => c.status === 'rejected');
                    
                    resultDiv.innerHTML += `<h3>ステータス別:</h3>`;
                    resultDiv.innerHTML += `<p>pending（申請中）: ${pending.length}件</p>`;
                    resultDiv.innerHTML += `<p>accepted（承認済み）: ${accepted.length}件</p>`;
                    resultDiv.innerHTML += `<p>rejected（拒否）: ${rejected.length}件</p>`;
                    
                    // 申請中の詳細
                    if (pending.length > 0) {
                        resultDiv.innerHTML += `<h3>申請中の詳細:</h3>`;
                        pending.forEach((conn, index) => {
                            const isReceived = conn.connected_user_id === user.id;
                            const type = isReceived ? '受信' : '送信';
                            resultDiv.innerHTML += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                                    <p>${index + 1}. ${type}</p>
                                    <p>ID: ${conn.id}</p>
                                    <p>送信者ID: ${conn.user_id}</p>
                                    <p>受信者ID: ${conn.connected_user_id}</p>
                                    <p>ステータス: ${conn.status}</p>
                                    <p>作成日: ${conn.created_at}</p>
                                    ${conn.message ? `<p>メッセージ: ${conn.message}</p>` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    // デバッグ用：全データをコンソールに出力
                    console.log('全コネクションデータ:', allConnections);
                } else {
                    resultDiv.innerHTML += '<p>コネクションデータがありません</p>';
                }
                
                // テスト用：申請中のコネクションを作成
                resultDiv.innerHTML += `
                    <h3>テスト用コネクション作成</h3>
                    <button onclick="createTestConnection()">テスト申請を作成</button>
                `;
                
            } catch (error) {
                resultDiv.innerHTML += `<p style="color: red;">例外エラー: ${error.message}</p>`;
                console.error('例外エラー:', error);
            }
        }
        
        async function createTestConnection() {
            try {
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                if (!user) {
                    alert('ログインしてください');
                    return;
                }
                
                // 他のユーザーを取得
                const { data: profiles } = await window.supabaseClient
                    .from('profiles')
                    .select('id, name')
                    .neq('id', user.id)
                    .limit(1);
                
                if (!profiles || profiles.length === 0) {
                    alert('他のユーザーが見つかりません');
                    return;
                }
                
                const targetUser = profiles[0];
                
                // テスト申請を作成（messageカラムが存在しない場合も考慮）
                const insertData = {
                    user_id: user.id,
                    connected_user_id: targetUser.id,
                    status: 'pending'
                };
                
                // messageカラムが存在する場合のみ追加
                // まずはmessageなしで試す
                const { data, error } = await window.supabaseClient
                    .from('connections')
                    .insert(insertData)
                    .select();
                
                if (error) {
                    alert('エラー: ' + error.message);
                    console.error('作成エラー:', error);
                } else {
                    alert(`${targetUser.name}への申請を作成しました`);
                    location.reload();
                }
            } catch (error) {
                alert('例外エラー: ' + error.message);
                console.error('例外エラー:', error);
            }
        }
        
        // ページ読み込み時に実行（DOM読み込み後）
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', testConnections);
        } else {
            // 少し遅延させて実行
            setTimeout(testConnections, 500);
        }
    </script>
</body>
</html>