<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>コネクションテスト</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>コネクションデータテスト</h1>
    <div id="result"></div>
    
    <script>
        // Supabase初期化
        const supabaseUrl = 'https://hnyuviqanlzpmdmsllpy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueXV2aXFhbmx6cG1kbXNsbHB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI0NDcxMTAsImV4cCI6MjA0ODAyMzExMH0.7nIvgdvcWpOBaJQifDQ10VWJNojE72KCXmmJxEv_BbU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        async function testConnections() {
            const resultDiv = document.getElementById('result');
            
            try {
                // 現在のユーザーを取得
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    resultDiv.innerHTML = '<p>ログインしていません</p>';
                    return;
                }
                
                resultDiv.innerHTML += `<p>現在のユーザーID: ${user.id}</p>`;
                resultDiv.innerHTML += `<p>メール: ${user.email}</p>`;
                
                // connectionsテーブルの全データを取得
                const { data: allConnections, error } = await supabase
                    .from('connections')
                    .select('*')
                    .or(`user_id.eq.${user.id},connected_user_id.eq.${user.id}`);
                
                if (error) {
                    resultDiv.innerHTML += `<p style="color: red;">エラー: ${error.message}</p>`;
                    console.error('エラー詳細:', error);
                    return;
                }
                
                resultDiv.innerHTML += `<h2>全コネクション数: ${allConnections ? allConnections.length : 0}</h2>`;
                
                if (allConnections && allConnections.length > 0) {
                    // ステータスごとに分類
                    const pending = allConnections.filter(c => c.status === 'pending');
                    const accepted = allConnections.filter(c => c.status === 'accepted');
                    const rejected = allConnections.filter(c => c.status === 'rejected');
                    
                    resultDiv.innerHTML += `<h3>ステータス別:</h3>`;
                    resultDiv.innerHTML += `<p>pending（申請中）: ${pending.length}件</p>`;
                    resultDiv.innerHTML += `<p>accepted（承認済み）: ${accepted.length}件</p>`;
                    resultDiv.innerHTML += `<p>rejected（拒否）: ${rejected.length}件</p>`;
                    
                    // 申請中の詳細
                    if (pending.length > 0) {
                        resultDiv.innerHTML += `<h3>申請中の詳細:</h3>`;
                        pending.forEach((conn, index) => {
                            const isReceived = conn.connected_user_id === user.id;
                            const type = isReceived ? '受信' : '送信';
                            resultDiv.innerHTML += `
                                <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
                                    <p>${index + 1}. ${type}</p>
                                    <p>ID: ${conn.id}</p>
                                    <p>送信者ID: ${conn.user_id}</p>
                                    <p>受信者ID: ${conn.connected_user_id}</p>
                                    <p>ステータス: ${conn.status}</p>
                                    <p>作成日: ${conn.created_at}</p>
                                    <p>メッセージ: ${conn.message || 'なし'}</p>
                                </div>
                            `;
                        });
                    }
                    
                    // デバッグ用：全データをコンソールに出力
                    console.log('全コネクションデータ:', allConnections);
                } else {
                    resultDiv.innerHTML += '<p>コネクションデータがありません</p>';
                }
                
                // テスト用：申請中のコネクションを作成
                resultDiv.innerHTML += `
                    <h3>テスト用コネクション作成</h3>
                    <button onclick="createTestConnection()">テスト申請を作成</button>
                `;
                
            } catch (error) {
                resultDiv.innerHTML += `<p style="color: red;">例外エラー: ${error.message}</p>`;
                console.error('例外エラー:', error);
            }
        }
        
        async function createTestConnection() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('ログインしてください');
                    return;
                }
                
                // 他のユーザーを取得
                const { data: profiles } = await supabase
                    .from('profiles')
                    .select('id, name')
                    .neq('id', user.id)
                    .limit(1);
                
                if (!profiles || profiles.length === 0) {
                    alert('他のユーザーが見つかりません');
                    return;
                }
                
                const targetUser = profiles[0];
                
                // テスト申請を作成
                const { data, error } = await supabase
                    .from('connections')
                    .insert({
                        user_id: user.id,
                        connected_user_id: targetUser.id,
                        status: 'pending',
                        message: 'テスト申請です'
                    })
                    .select();
                
                if (error) {
                    alert('エラー: ' + error.message);
                    console.error('作成エラー:', error);
                } else {
                    alert(`${targetUser.name}への申請を作成しました`);
                    location.reload();
                }
            } catch (error) {
                alert('例外エラー: ' + error.message);
                console.error('例外エラー:', error);
            }
        }
        
        // ページ読み込み時に実行
        testConnections();
    </script>
</body>
</html>