/**
 * Matching Perfect Integration
 * „Éû„ÉÉ„ÉÅ„É≥„Ç∞Ê©üËÉΩ„ÅÆÂÆåÁíß„Å™Áµ±Âêà„Å®Âà∂Âæ°
 * „Åô„Åπ„Å¶„ÅÆÁ´∂Âêà„ÇíËß£Ê±∫„Åó„ÄÅ„Ç®„É©„Éº„ÇíÈò≤Ê≠¢
 */

(function() {
    'use strict';
    
    console.log('[PerfectIntegration] üöÄ „Éû„ÉÉ„ÉÅ„É≥„Ç∞Ê©üËÉΩ„ÅÆÂÆåÁíß„Å™Áµ±Âêà„ÇíÈñãÂßã');
    
    // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖãÁÆ°ÁêÜ
    window.matchingPerfectIntegration = {
        initialized: false,
        components: new Map(),
        profiles: [],
        charts: new Map(),
        eventHandlers: new Map(),
        errors: [],
        performanceMetrics: {
            startTime: Date.now(),
            profileLoadTime: 0,
            renderTime: 0,
            chartRenderTime: 0
        }
    };
    
    const MPI = window.matchingPerfectIntegration;
    
    /**
     * „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„É©„ÉÉ„Éë„Éº
     */
    function safeExecute(fn, context, args = [], fallbackValue = null) {
        try {
            return fn.apply(context, args);
        } catch (error) {
            console.error('[PerfectIntegration] „Ç®„É©„ÉºÁô∫Áîü:', error);
            MPI.errors.push({
                time: new Date(),
                error: error,
                function: fn.name || 'anonymous',
                stack: error.stack
            });
            return fallbackValue;
        }
    }
    
    /**
     * Á´∂Âêà„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆåÂÖ®„Å´ÁÑ°ÂäπÂåñ
     */
    function disableAllConflictingScripts() {
        const conflictingScripts = [
            'matchingCompleteFix',
            'matchingEmergencyFix',
            'matchingErrorDiagnostic',
            'matchingPerfectDisplay',
            'matchingFixAllIssues',
            'matchingConflictResolver',
            'matchingVerifyPerfection',
            'matchingFeatureTest'
        ];
        
        conflictingScripts.forEach(name => {
            if (window[name]) {
                // ÁÑ°ÂäπÂåñ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
                window[name]._disabled = true;
                window[name]._disabledBy = 'matchingPerfectIntegration';
                
                // ‰∏ªË¶Å„É°„ÇΩ„ÉÉ„Éâ„Çínoop„Å´ÁΩÆ„ÅçÊèõ„Åà
                if (typeof window[name] === 'object') {
                    Object.keys(window[name]).forEach(key => {
                        if (typeof window[name][key] === 'function') {
                            window[name][key] = () => {
                                console.log(`[PerfectIntegration] ${name}.${key}„ÅØÁÑ°ÂäπÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô`);
                            };
                        }
                    });
                }
                
                console.log(`[PerfectIntegration] ‚úÖ ${name}„ÇíÁÑ°ÂäπÂåñ`);
            }
        });
    }
    
    /**
     * „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà„Ç∑„Çπ„ÉÜ„É†„ÅÆ‰øÆÊ≠£Áâà
     */
    class PerfectRadarChart {
        constructor(canvasId, profileData) {
            this.canvasId = canvasId;
            this.canvas = document.querySelector(`#${canvasId} canvas`);
            this.profileData = profileData;
            this.isAnimating = false;
            this.animationFrame = null;
            
            if (this.canvas) {
                this.ctx = this.canvas.getContext('2d');
                this.centerX = 100;
                this.centerY = 100;
                this.radius = 80;
                this.init();
            }
        }
        
        init() {
            // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„Çí„Éê„Ç§„É≥„Éâ
            this.handleMouseEnter = this.handleMouseEnter.bind(this);
            this.handleMouseLeave = this.handleMouseLeave.bind(this);
            
            // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
            this.canvas.removeEventListener('mouseenter', this.handleMouseEnter);
            this.canvas.removeEventListener('mouseleave', this.handleMouseLeave);
            
            // Êñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            this.canvas.addEventListener('mouseenter', this.handleMouseEnter);
            this.canvas.addEventListener('mouseleave', this.handleMouseLeave);
            
            // ÂàùÊúüÊèèÁîª
            this.draw();
        }
        
        handleMouseEnter(e) {
            safeExecute(() => {
                if (!this.isAnimating) {
                    this.animateHover(1.1);
                }
            }, this);
        }
        
        handleMouseLeave(e) {
            safeExecute(() => {
                if (!this.isAnimating) {
                    this.animateHover(1.0);
                }
            }, this);
        }
        
        animateHover(targetScale) {
            if (this.animationFrame) {
                cancelAnimationFrame(this.animationFrame);
            }
            
            this.isAnimating = true;
            const startScale = this.currentScale || 1.0;
            const startTime = performance.now();
            const duration = 300;
            
            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // „Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                this.currentScale = startScale + (targetScale - startScale) * easeOutCubic;
                
                this.draw(this.currentScale);
                
                if (progress < 1) {
                    this.animationFrame = requestAnimationFrame(animate);
                } else {
                    this.isAnimating = false;
                    this.animationFrame = null;
                }
            };
            
            this.animationFrame = requestAnimationFrame(animate);
        }
        
        draw(scale = 1.0) {
            if (!this.ctx) return;
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢
            this.ctx.clearRect(0, 0, 200, 200);
            
            // „Çπ„Ç±„Éº„É´ÈÅ©Áî®
            this.ctx.save();
            this.ctx.translate(this.centerX, this.centerY);
            this.ctx.scale(scale, scale);
            this.ctx.translate(-this.centerX, -this.centerY);
            
            // „Ç∞„É™„ÉÉ„Éâ„ÇíÊèèÁîª
            this.drawGrid();
            
            // „Éá„Éº„Çø„ÇíÊèèÁîª
            this.drawData();
            
            this.ctx.restore();
        }
        
        drawGrid() {
            this.ctx.strokeStyle = '#e0e0e0';
            this.ctx.lineWidth = 1;
            
            // ÂêåÂøÉÂÜÜ
            for (let i = 1; i <= 5; i++) {
                this.ctx.beginPath();
                this.ctx.arc(this.centerX, this.centerY, (this.radius / 5) * i, 0, Math.PI * 2);
                this.ctx.stroke();
            }
            
            // Ëª∏
            const axes = 6;
            for (let i = 0; i < axes; i++) {
                const angle = (Math.PI * 2 / axes) * i - Math.PI / 2;
                this.ctx.beginPath();
                this.ctx.moveTo(this.centerX, this.centerY);
                this.ctx.lineTo(
                    this.centerX + Math.cos(angle) * this.radius,
                    this.centerY + Math.sin(angle) * this.radius
                );
                this.ctx.stroke();
            }
        }
        
        drawData() {
            const values = this.calculateValues();
            const axes = 6;
            
            // „Éá„Éº„Çø„Ç®„É™„Ç¢„ÇíÊèèÁîª
            this.ctx.fillStyle = 'rgba(52, 152, 219, 0.3)';
            this.ctx.strokeStyle = '#3498db';
            this.ctx.lineWidth = 2;
            this.ctx.beginPath();
            
            values.forEach((value, i) => {
                const angle = (Math.PI * 2 / axes) * i - Math.PI / 2;
                const x = this.centerX + Math.cos(angle) * (this.radius * value / 100);
                const y = this.centerY + Math.sin(angle) * (this.radius * value / 100);
                
                if (i === 0) this.ctx.moveTo(x, y);
                else this.ctx.lineTo(x, y);
            });
            
            this.ctx.closePath();
            this.ctx.fill();
            this.ctx.stroke();
        }
        
        calculateValues() {
            const profile = this.profileData;
            return [
                Math.min((profile.skills?.length || 0) * 20, 100),
                profile.location ? 80 : 20,
                profile.industry ? 80 : 20,
                Math.random() * 80 + 20,
                Math.random() * 80 + 20,
                (profile.interests?.length || 0) * 25
            ];
        }
        
        destroy() {
            if (this.canvas) {
                this.canvas.removeEventListener('mouseenter', this.handleMouseEnter);
                this.canvas.removeEventListener('mouseleave', this.handleMouseLeave);
            }
            if (this.animationFrame) {
                cancelAnimationFrame(this.animationFrame);
            }
        }
    }
    
    /**
     * „Éó„É≠„Éï„Ç°„Ç§„É´Ë°®Á§∫„ÅÆÂÆåÁíß„Å™ÂÆüË£Ö
     */
    function displayProfiles(profiles) {
        console.log('[PerfectIntegration] „Éó„É≠„Éï„Ç°„Ç§„É´Ë°®Á§∫ÈñãÂßã:', profiles.length);
        const startTime = performance.now();
        
        const container = document.getElementById('matching-container');
        if (!container) {
            console.error('[PerfectIntegration] matching-container„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            return;
        }
        
        // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        MPI.charts.forEach(chart => chart.destroy());
        MPI.charts.clear();
        
        // „Éó„É≠„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò
        MPI.profiles = profiles;
        
        // „Çπ„Ç≥„Ç¢„ÇíË®àÁÆó
        const profilesWithScore = profiles.map(profile => ({
            ...profile,
            matchingScore: calculatePerfectScore(profile)
        }));
        
        // „Çπ„Ç≥„Ç¢„Åß„ÇΩ„Éº„Éà
        profilesWithScore.sort((a, b) => b.matchingScore - a.matchingScore);
        
        // HTMLÁîüÊàê
        const html = `
            <div class="matching-grid">
                ${profilesWithScore.map((profile, index) => 
                    createPerfectMatchingCard(profile, index)
                ).join('')}
            </div>
        `;
        
        container.innerHTML = html;
        
        // „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà„ÇíÊèèÁîª
        setTimeout(() => {
            profilesWithScore.forEach((profile, index) => {
                const chart = new PerfectRadarChart(`radar-${index}`, profile);
                MPI.charts.set(index, chart);
            });
        }, 100);
        
        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÇíË®≠ÂÆö
        setupPerfectEventHandlers();
        
        // Áµ±Ë®à„ÇíÊõ¥Êñ∞
        updateMatchingStats(profilesWithScore);
        
        const endTime = performance.now();
        MPI.performanceMetrics.renderTime = endTime - startTime;
        console.log(`[PerfectIntegration] Ë°®Á§∫ÂÆå‰∫Ü - ${MPI.performanceMetrics.renderTime.toFixed(2)}ms`);
    }
    
    /**
     * ÂÆåÁíß„Å™„Çπ„Ç≥„Ç¢Ë®àÁÆó
     */
    function calculatePerfectScore(profile) {
        // „Éô„Éº„Çπ„Çπ„Ç≥„Ç¢
        let score = 15 + Math.random() * 15;
        
        // „Éó„É≠„Éï„Ç°„Ç§„É´Ë¶ÅÁ¥†„Å´„Çà„ÇãÂä†ÁÇπ
        const factors = {
            skills: Math.min((profile.skills?.length || 0) * 3, 15),
            interests: Math.min((profile.interests?.length || 0) * 2, 10),
            location: profile.location ? 8 : 0,
            industry: profile.industry ? 8 : 0,
            title: profile.title ? 5 : 0,
            company: profile.company ? 5 : 0,
            bio: profile.bio?.length > 50 ? 7 : 0
        };
        
        Object.values(factors).forEach(value => score += value);
        
        // „Ç¨„Ç¶„ÇπÂàÜÂ∏É„Åß„É©„É≥„ÉÄ„É†ÊÄß„ÇíËøΩÂä†
        const gaussian = () => {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        };
        
        score += gaussian() * 10;
        
        // 15-95„ÅÆÁØÑÂõ≤„Å´„ÇØ„É™„ÉÉ„Éó
        return Math.max(15, Math.min(95, Math.round(score)));
    }
    
    /**
     * ÂÆåÁíß„Å™„Éû„ÉÉ„ÉÅ„É≥„Ç∞„Ç´„Éº„ÉâHTML
     */
    function createPerfectMatchingCard(profile, index) {
        const scoreColor = profile.matchingScore >= 80 ? '#27ae60' : 
                          profile.matchingScore >= 60 ? '#3498db' : '#95a5a6';
        
        const avatarUrl = profile.avatar_url || 
                         `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.name || 'User')}&background=random`;
        
        return `
            <div class="matching-card perfect-card" data-profile-id="${profile.id}" data-index="${index}">
                <div class="score-badge" style="background: ${scoreColor};">
                    ${profile.matchingScore}%
                </div>
                
                <div class="profile-header">
                    <img src="${avatarUrl}" alt="${profile.name || '„É¶„Éº„Ç∂„Éº'}" class="profile-avatar">
                    <h3>${profile.name || 'ÂêçÂâçÊú™Ë®≠ÂÆö'}</h3>
                    <p class="profile-title">
                        ${profile.title || ''}${profile.company ? ` @ ${profile.company}` : ''}
                    </p>
                </div>
                
                <div id="radar-${index}" class="radar-container">
                    <canvas width="200" height="200"></canvas>
                </div>
                
                ${profile.skills?.length > 0 ? `
                    <div class="skills-container">
                        ${profile.skills.slice(0, 3).map(skill => 
                            `<span class="skill-tag">${skill}</span>`
                        ).join('')}
                        ${profile.skills.length > 3 ? 
                            `<span class="skill-more">+${profile.skills.length - 3}</span>` : ''
                        }
                    </div>
                ` : ''}
                
                <div class="card-actions">
                    <button class="btn-view-profile" data-profile-id="${profile.id}">
                        Ë©≥Á¥∞„ÇíË¶ã„Çã
                    </button>
                    <button class="btn-connect-perfect" data-profile-id="${profile.id}">
                        „Ç≥„Éç„ÇØ„ÉàÁî≥Ë´ã
                    </button>
                </div>
            </div>
        `;
    }
    
    /**
     * „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆË®≠ÂÆö
     */
    function setupPerfectEventHandlers() {
        // Êó¢Â≠ò„ÅÆ„Éè„É≥„Éâ„É©„Éº„Çí„ÇØ„É™„Ç¢
        MPI.eventHandlers.forEach((handler, key) => {
            const [element, event] = key.split(':');
            document.removeEventListener(event, handler);
        });
        MPI.eventHandlers.clear();
        
        // Ë©≥Á¥∞„Éú„Çø„É≥
        document.querySelectorAll('.btn-view-profile').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const profileId = btn.dataset.profileId;
                if (window.profileDetailModal?.show) {
                    window.profileDetailModal.show(profileId);
                } else {
                    console.error('[PerfectIntegration] profileDetailModal„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                }
            });
        });
        
        // „Ç≥„Éç„ÇØ„Éà„Éú„Çø„É≥
        document.querySelectorAll('.btn-connect-perfect').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const profileId = btn.dataset.profileId;
                
                if (!profileId) {
                    console.error('[PerfectIntegration] „Éó„É≠„Éï„Ç°„Ç§„É´ID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÈÄÅ‰ø°‰∏≠...';
                
                try {
                    const { data: { user } } = await window.supabase.auth.getUser();
                    if (!user) throw new Error('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                    
                    const { error } = await window.supabase
                        .from('connections')
                        .insert({
                            user_id: user.id,
                            connected_user_id: profileId,
                            status: 'pending'
                        });
                    
                    if (error) throw error;
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> Áî≥Ë´ãÊ∏à„Åø';
                    btn.style.background = '#27ae60';
                    
                } catch (error) {
                    console.error('[PerfectIntegration] „Ç≥„Éç„ÇØ„ÉàÁî≥Ë´ã„Ç®„É©„Éº:', error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('„Ç≥„Éç„ÇØ„ÉàÁî≥Ë´ã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            });
        });
    }
    
    /**
     * Áµ±Ë®àÊÉÖÂ†±„ÅÆÊõ¥Êñ∞
     */
    function updateMatchingStats(profiles) {
        const totalCount = document.querySelector('.total-count');
        const highMatchCount = document.querySelector('.high-match-count');
        const avgScore = document.querySelector('.avg-score');
        
        if (totalCount) {
            totalCount.textContent = profiles.length;
        }
        
        if (highMatchCount) {
            const highMatches = profiles.filter(p => p.matchingScore >= 70).length;
            highMatchCount.textContent = highMatches;
        }
        
        if (avgScore) {
            const average = profiles.reduce((sum, p) => sum + p.matchingScore, 0) / profiles.length;
            avgScore.textContent = Math.round(average) + '%';
        }
    }
    
    /**
     * „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å®ÂàùÊúüÂåñ
     */
    async function loadAndInitialize() {
        if (MPI.initialized) {
            console.log('[PerfectIntegration] „Åô„Åß„Å´ÂàùÊúüÂåñÊ∏à„Åø');
            return;
        }
        
        console.log('[PerfectIntegration] „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÈñãÂßã');
        const startTime = performance.now();
        
        try {
            // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
            const { data: { user } } = await window.supabase.auth.getUser();
            if (!user) throw new Error('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
            
            // „Éó„É≠„Éï„Ç°„Ç§„É´ÂèñÂæó
            const { data: profiles, error } = await window.supabase
                .from('profiles')
                .select('*')
                .neq('id', user.id)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            const endTime = performance.now();
            MPI.performanceMetrics.profileLoadTime = endTime - startTime;
            
            console.log(`[PerfectIntegration] ${profiles.length}‰ª∂„ÅÆ„Éó„É≠„Éï„Ç°„Ç§„É´„ÇíÂèñÂæó (${MPI.performanceMetrics.profileLoadTime.toFixed(2)}ms)`);
            
            // Ë°®Á§∫
            displayProfiles(profiles || []);
            
            MPI.initialized = true;
            
        } catch (error) {
            console.error('[PerfectIntegration] ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            MPI.errors.push({
                time: new Date(),
                error: error,
                phase: 'initialization'
            });
            
            // „Ç®„É©„ÉºË°®Á§∫
            const container = document.getElementById('matching-container');
            if (container) {
                container.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}</p>
                        <button onclick="window.matchingPerfectIntegration.reload()">
                            ÂÜçË™≠„ÅøËæº„Åø
                        </button>
                    </div>
                `;
            }
        }
    }
    
    /**
     * ÂÖ¨ÈñãAPI
     */
    MPI.init = function() {
        console.log('[PerfectIntegration] ÊâãÂãïÂàùÊúüÂåñ');
        disableAllConflictingScripts();
        loadAndInitialize();
    };
    
    MPI.reload = function() {
        console.log('[PerfectIntegration] „É™„É≠„Éº„Éâ');
        MPI.initialized = false;
        loadAndInitialize();
    };
    
    MPI.getStatus = function() {
        return {
            initialized: MPI.initialized,
            profileCount: MPI.profiles.length,
            chartCount: MPI.charts.size,
            errors: MPI.errors.length,
            performance: MPI.performanceMetrics
        };
    };
    
    MPI.clearErrors = function() {
        MPI.errors = [];
        console.log('[PerfectIntegration] „Ç®„É©„Éº„É≠„Ç∞„Çí„ÇØ„É™„Ç¢');
    };
    
    // displayProfiles„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
    window.displayProfiles = displayProfiles;
    
    // Êó¢Â≠ò„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ
    if (window.matchingSupabase) {
        window.matchingSupabase.displayProfiles = displayProfiles;
    }
    
    // 5ÁßíÂæå„Å´Ëá™ÂãïÂàùÊúüÂåñ
    setTimeout(() => {
        if (!MPI.initialized) {
            console.log('[PerfectIntegration] Ëá™ÂãïÂàùÊúüÂåñÈñãÂßã');
            disableAllConflictingScripts();
            loadAndInitialize();
        }
    }, 5000);
    
    console.log('[PerfectIntegration] ‚ú® Ê∫ñÂÇôÂÆå‰∫Ü');
    console.log('ÊâãÂãïÂàùÊúüÂåñ: matchingPerfectIntegration.init()');
    console.log('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç: matchingPerfectIntegration.getStatus()');
    
})();