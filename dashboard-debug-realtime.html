<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Realtime Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
        .console { background: #111; border: 1px solid #0f0; padding: 10px; margin: 10px 0; height: 400px; overflow-y: auto; }
        .log { margin: 2px 0; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
        button:hover { background: #0a0; }
        .status { padding: 10px; margin: 10px 0; border: 1px solid #0f0; }
    </style>
</head>
<body>
    <h1>Dashboard Realtime Debug Console</h1>
    
    <div class="status">
        <button onclick="initDashboard()">Initialize Dashboard</button>
        <button onclick="fetchData()">Fetch All Data</button>
        <button onclick="clearConsole()">Clear Console</button>
        <button onclick="simulateUpdate()">Simulate Update</button>
    </div>

    <div class="console" id="console"></div>

    <!-- Load all dashboard scripts -->
    <script src="js/error-prevention.js"></script>
    <script src="js/null-check-fixes.js"></script>
    <script src="js/safe-dom-utils.js"></script>
    <script src="js/safe-storage.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/global-functions.js"></script>
    <script src="js/dashboard-data.js"></script>
    <script src="js/dashboard-ui.js"></script>
    <script src="js/dashboard-updater.js"></script>

    <script>
        const consoleDiv = document.getElementById('console');
        let logCount = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(logEntry);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            logCount++;
            
            // Keep only last 100 logs
            if (logCount > 100) {
                consoleDiv.removeChild(consoleDiv.firstChild);
                logCount--;
            }
        }

        function clearConsole() {
            consoleDiv.innerHTML = '';
            logCount = 0;
            log('Console cleared', 'info');
        }

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function(...args) {
            log(args.join(' '), 'info');
            originalLog.apply(console, args);
        };

        console.warn = function(...args) {
            log(args.join(' '), 'warning');
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            log(args.join(' '), 'error');
            originalError.apply(console, args);
        };

        async function initDashboard() {
            log('=== INITIALIZING DASHBOARD ===', 'success');
            
            try {
                // Check Supabase
                if (!window.supabase) {
                    log('Supabase not loaded!', 'error');
                    return;
                }
                log('Supabase loaded', 'success');

                // Check auth
                const { data: { user } } = await window.supabase.auth.getUser();
                if (user) {
                    log(`Authenticated as: ${user.email}`, 'success');
                } else {
                    log('Not authenticated', 'warning');
                }

                // Check dashboard components
                if (window.dashboardStats) {
                    log('DashboardStats available', 'success');
                    await window.dashboardStats.init();
                    log('DashboardStats initialized', 'success');
                } else {
                    log('DashboardStats not found', 'error');
                }

                if (window.dashboardUI) {
                    log('DashboardUI available', 'success');
                } else {
                    log('DashboardUI not found', 'error');
                }

                if (window.dashboardUpdater) {
                    log('DashboardUpdater available', 'success');
                    await window.dashboardUpdater.init();
                    log('DashboardUpdater initialized', 'success');
                } else {
                    log('DashboardUpdater not found', 'error');
                }

            } catch (error) {
                log(`Initialization error: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        async function fetchData() {
            log('=== FETCHING ALL DATA ===', 'success');
            
            if (!window.dashboardStats) {
                log('DashboardStats not available', 'error');
                return;
            }

            try {
                // Fetch stats
                log('Fetching dashboard stats...', 'info');
                const stats = await window.dashboardStats.fetchDashboardStats();
                log(`Stats fetched: ${JSON.stringify(stats)}`, 'success');

                // Fetch activities
                log('Fetching recent activities...', 'info');
                const activities = await window.dashboardStats.fetchRecentActivities();
                log(`Activities fetched: ${activities.length} items`, 'success');
                activities.forEach((activity, i) => {
                    log(`Activity ${i}: ${JSON.stringify(activity)}`, 'info');
                });

                // Fetch events
                log('Fetching upcoming events...', 'info');
                const events = await window.dashboardStats.fetchUpcomingEvents();
                log(`Events fetched: ${events.length} items`, 'success');
                events.forEach((event, i) => {
                    log(`Event ${i}: ${JSON.stringify(event)}`, 'info');
                });

                // Update UI
                if (window.dashboardUI) {
                    log('Updating UI...', 'info');
                    window.dashboardUI.updateStatCards(stats);
                    window.dashboardUI.renderRecentActivities(activities);
                    window.dashboardUI.renderUpcomingEvents(events);
                    log('UI updated', 'success');
                }

            } catch (error) {
                log(`Fetch error: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        async function simulateUpdate() {
            log('=== SIMULATING DATA UPDATE ===', 'success');
            
            if (!window.dashboardUI) {
                log('DashboardUI not available', 'error');
                return;
            }

            // Create mock data
            const mockStats = {
                total_members: Math.floor(Math.random() * 2000) + 1000,
                monthly_events: Math.floor(Math.random() * 30) + 10,
                matching_success: Math.floor(Math.random() * 100) + 50,
                unread_messages: Math.floor(Math.random() * 50),
                member_growth_percentage: (Math.random() * 20 - 10).toFixed(1),
                event_increase: Math.floor(Math.random() * 10) - 5
            };

            log(`Mock stats: ${JSON.stringify(mockStats)}`, 'info');
            
            // Update UI
            window.dashboardUI.updateStatCards(mockStats);
            log('UI updated with mock data', 'success');
        }

        // Auto-initialize when ready
        window.addEventListener('supabaseReady', () => {
            log('Supabase ready event received', 'success');
            setTimeout(initDashboard, 1000);
        });

        // Initial log
        log('Dashboard Debug Console Ready', 'success');
        log('Waiting for Supabase...', 'info');
    </script>
</body>
</html>