<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEË™çË®º‰∏≠ - INTERCONNECT</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth-unified.css">
    
    <style>
        .callback-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .callback-card {
            background: white;
            border-radius: 20px;
            padding: 48px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
        }
        
        .callback-icon {
            font-size: 4rem;
            color: #00C300;
            margin-bottom: 24px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .callback-title {
            font-size: 1.5rem;
            color: #1a1a1a;
            margin-bottom: 16px;
        }
        
        .callback-message {
            color: #64748b;
            margin-bottom: 24px;
        }
        
        .error-message {
            color: #dc2626;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="callback-card">
            <i class="fab fa-line callback-icon"></i>
            <h2 class="callback-title">LINEË™çË®ºÂá¶ÁêÜ‰∏≠</h2>
            <p class="callback-message">„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...</p>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/supabase-client.js"></script>
    <script src="js/line-callback-debug.js"></script>
    <script>
        // Supabase„ÅåÊ∫ñÂÇô„Åß„Åç„Çã„Åæ„ÅßÂæÖ„Å§
        window.addEventListener('supabaseReady', function() {
            console.log('üìç supabaseReady event fired in line-callback.html');
            handleLineCallback();
        });
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöSupabase„ÅåÊó¢„Å´Ê∫ñÂÇôÊ∏à„Åø„ÅÆÂ†¥Âêà
        if (window.supabase) {
            console.log('üìç Supabase already ready, calling handleLineCallback');
            handleLineCallback();
        }
        
        // „Åï„Çâ„Å™„Çã„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöDOMContentLoaded„ÅßÂÆüË°å
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìç DOMContentLoaded in line-callback.html');
            setTimeout(function() {
                if (window.supabase && !window._callbackHandled) {
                    console.log('üìç Fallback: calling handleLineCallback');
                    handleLineCallback();
                }
            }, 1000);
        });
        
        async function handleLineCallback() {
            // ÈáçË§áÂÆüË°å„ÇíÈò≤„Åê
            if (window._callbackHandled) {
                console.log('‚ö†Ô∏è Callback already handled, skipping');
                return;
            }
            window._callbackHandled = true;
            
            console.log('üöÄ handleLineCallback started');
            
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            console.log('üìå Processing callback with:', {
                code: code ? code.substring(0, 10) + '...' : null,
                state: state ? state.substring(0, 10) + '...' : null,
                error: error
            });
            
            // „Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            if (error) {
                showError(`Ë™çË®º„Ç®„É©„Éº: ${errorDescription || error}`);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            // state„ÉÅ„Çß„ÉÉ„ÇØÔºàCSRFÂØæÁ≠ñÔºâ
            const savedState = sessionStorage.getItem('line_state');
            if (!state || state !== savedState) {
                showError('‰∏çÊ≠£„Å™„É™„ÇØ„Ç®„Çπ„Éà„Åß„Åô');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            // code„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà
            if (!code) {
                showError('Ë™çË®º„Ç≥„Éº„Éâ„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            try {
                console.log('üì° Calling Netlify Function...');
                const apiUrl = '/.netlify/functions/line-auth-simple-v3';
                const requestBody = {
                    code: code,
                    redirect_uri: window.location.origin + '/line-callback.html'
                };
                
                console.log('API URL:', apiUrl);
                console.log('Request Body:', requestBody);
                
                // „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâAPI„ÇíÂëº„Å≥Âá∫„Åó„Å¶LINEË™çË®º„ÇíÂá¶ÁêÜÔºàv2„Çí‰ΩøÁî®Ôºâ
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('üì° Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('Auth API Error:', error);
                    
                    // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Çí„É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å´
                    let userMessage = 'Ë™çË®ºÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                    if (error.error) {
                        if (error.error.includes('Database')) {
                            userMessage = '„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„Çâ„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        } else if (error.error.includes('token')) {
                            userMessage = 'LINEË™çË®º„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        } else if (error.error.includes('configuration')) {
                            userMessage = '„Çµ„Éº„Éê„ÉºË®≠ÂÆö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ';
                        }
                    }
                    
                    showError(userMessage);
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 5000);
                    return;
                }
                
                const data = await response.json();
                console.log('üì° Auth response data:', data);
                
                // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Çí‰øùÂ≠ò
                const userData = {
                    id: data.user.id,
                    email: data.user.email,
                    name: data.user.display_name,
                    picture: data.user.picture_url,
                    provider: 'line',
                    line_user_id: data.user.line_user_id
                };
                
                console.log('Saving user data:', userData);
                localStorage.setItem('user', JSON.stringify(userData));
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†±„ÇÇ‰øùÂ≠òÔºà‰ªÆ„ÅÆÂÆüË£ÖÔºâ
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('userEmail', data.user.email);
                
                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                document.querySelector('.callback-message').textContent = 'Ë™çË®ºÊàêÂäüÔºÅ„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Å¶„ÅÑ„Åæ„Åô...';
                
                // ÊàêÂäü„Ç¢„Ç§„Ç≥„É≥„Å´Â§âÊõ¥
                const icon = document.querySelector('.callback-icon');
                if (icon) {
                    icon.className = 'fas fa-check-circle callback-icon';
                    icon.style.color = '#10b981';
                }
                
                // „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å∏„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                console.log('Redirecting to dashboard...');
                setTimeout(() => {
                    window.location.href = data.redirect_to || 'dashboard.html';
                }, 1000);
                
            } catch (err) {
                console.error('LINEË™çË®º„Ç®„É©„Éº:', err);
                showError('Ë™çË®ºÂá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>