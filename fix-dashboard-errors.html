<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Fix Dashboard Errors</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        button { margin: 5px; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Dashboard Error Fix Tool</h1>
    
    <div class="section">
        <h2>1. Check Table Structure</h2>
        <button onclick="checkTables()">Check Tables</button>
        <div id="table-results"></div>
    </div>

    <div class="section">
        <h2>2. Fix Dashboard Stats</h2>
        <button onclick="fixDashboardStats()">Fix Stats Table</button>
        <div id="stats-results"></div>
    </div>

    <div class="section">
        <h2>3. Test Queries</h2>
        <button onclick="testQueries()">Test All Queries</button>
        <div id="query-results"></div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        function log(section, message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            document.getElementById(`${section}-results`).appendChild(div);
        }

        async function checkTables() {
            const results = document.getElementById('table-results');
            results.innerHTML = '';
            
            const tables = ['dashboard_stats', 'events', 'user_activities', 'messages'];
            
            for (const table of tables) {
                try {
                    const { data, error, count } = await window.supabase
                        .from(table)
                        .select('*', { count: 'exact' })
                        .limit(1);
                    
                    if (error) {
                        log('table', `${table}: ❌ Error - ${error.message}`, 'error');
                    } else {
                        log('table', `${table}: ✅ OK - ${count || 0} records`, 'success');
                        if (data && data.length > 0) {
                            log('table', `<pre>Columns: ${Object.keys(data[0]).join(', ')}</pre>`, 'info');
                        }
                    }
                } catch (e) {
                    log('table', `${table}: ❌ Exception - ${e.message}`, 'error');
                }
            }
        }

        async function fixDashboardStats() {
            const results = document.getElementById('stats-results');
            results.innerHTML = '';
            
            try {
                // まず既存のデータを確認
                const { data: existing, error: checkError } = await window.supabase
                    .from('dashboard_stats')
                    .select('*')
                    .limit(1);
                
                if (checkError) {
                    log('stats', `Check error: ${checkError.message}`, 'error');
                    return;
                }
                
                if (existing && existing.length > 0) {
                    log('stats', 'Dashboard stats already exists', 'info');
                    log('stats', `<pre>${JSON.stringify(existing[0], null, 2)}</pre>`, 'info');
                } else {
                    // 新しいレコードを作成
                    const newStats = {
                        total_members: 1234,
                        monthly_events: 15,
                        matching_success: 89,
                        unread_messages: 42,
                        member_growth_percentage: 12.0,
                        event_increase: 3,
                        matching_success_percentage: 23.0,
                        message_decrease_percentage: 5.0
                    };
                    
                    const { data, error } = await window.supabase
                        .from('dashboard_stats')
                        .insert([newStats])
                        .select();
                    
                    if (error) {
                        log('stats', `Insert error: ${error.message}`, 'error');
                    } else {
                        log('stats', 'Dashboard stats created successfully!', 'success');
                        log('stats', `<pre>${JSON.stringify(data[0], null, 2)}</pre>`, 'info');
                    }
                }
            } catch (e) {
                log('stats', `Exception: ${e.message}`, 'error');
            }
        }

        async function testQueries() {
            const results = document.getElementById('query-results');
            results.innerHTML = '';
            
            // Test different query formats
            const queries = [
                {
                    name: 'Dashboard Stats (single)',
                    query: async () => await window.supabase
                        .from('dashboard_stats')
                        .select('*')
                        .single()
                },
                {
                    name: 'Dashboard Stats (maybeSingle)',
                    query: async () => await window.supabase
                        .from('dashboard_stats')
                        .select('*')
                        .limit(1)
                        .maybeSingle()
                },
                {
                    name: 'Dashboard Stats (limit 1)',
                    query: async () => await window.supabase
                        .from('dashboard_stats')
                        .select('*')
                        .limit(1)
                },
                {
                    name: 'Messages count',
                    query: async () => await window.supabase
                        .from('messages')
                        .select('*', { count: 'exact', head: true })
                },
                {
                    name: 'Events',
                    query: async () => await window.supabase
                        .from('events')
                        .select('*')
                        .limit(5)
                },
                {
                    name: 'User Activities',
                    query: async () => await window.supabase
                        .from('user_activities')
                        .select('*')
                        .limit(5)
                }
            ];
            
            for (const test of queries) {
                try {
                    const result = await test.query();
                    if (result.error) {
                        log('query', `${test.name}: ❌ ${result.error.message}`, 'error');
                    } else {
                        log('query', `${test.name}: ✅ Success`, 'success');
                        if (result.data !== undefined) {
                            const dataInfo = Array.isArray(result.data) 
                                ? `${result.data.length} records` 
                                : result.data ? '1 record' : 'null';
                            log('query', `Data: ${dataInfo}, Count: ${result.count || 'N/A'}`, 'info');
                        }
                    }
                } catch (e) {
                    log('query', `${test.name}: ❌ Exception - ${e.message}`, 'error');
                }
            }
        }

        // Auto-run on load
        window.addEventListener('supabaseReady', () => {
            checkTables();
        });
    </script>
</body>
</html>