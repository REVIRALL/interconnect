<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Simple Table Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>Simple Table Test</h1>
    
    <div class="section">
        <h2>Auth Status</h2>
        <button onclick="checkAuth()">Check Auth</button>
        <div id="auth-result"></div>
    </div>

    <div class="section">
        <h2>Simple Read Tests</h2>
        <button onclick="testSimpleRead('dashboard_stats')">Read dashboard_stats</button>
        <button onclick="testSimpleRead('events')">Read events</button>
        <button onclick="testSimpleRead('user_activities')">Read user_activities</button>
        <button onclick="testSimpleRead('messages')">Read messages</button>
        <div id="read-result"></div>
    </div>

    <div class="section">
        <h2>Create Test Data</h2>
        <button onclick="createTestStats()">Create Test Stats</button>
        <button onclick="createTestEvent()">Create Test Event</button>
        <div id="create-result"></div>
    </div>

    <script src="js/supabase-client.js"></script>
    <script>
        async function checkAuth() {
            const result = document.getElementById('auth-result');
            
            try {
                const { data: { user }, error } = await window.supabase.auth.getUser();
                
                if (error) {
                    result.innerHTML = `<p class="error">Auth Error: ${error.message}</p>`;
                } else if (user) {
                    result.innerHTML = `<p class="success">Logged in as: ${user.email}</p>`;
                } else {
                    result.innerHTML = `<p class="error">Not logged in</p>`;
                }
            } catch (e) {
                result.innerHTML = `<p class="error">Exception: ${e.message}</p>`;
            }
        }

        async function testSimpleRead(tableName) {
            const result = document.getElementById('read-result');
            result.innerHTML = `<p>Reading ${tableName}...</p>`;
            
            try {
                // シンプルな全件取得
                const { data, error } = await window.supabase
                    .from(tableName)
                    .select('*');
                
                if (error) {
                    result.innerHTML = `<p class="error">${tableName} Error: ${error.message}</p>`;
                    if (error.details) {
                        result.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
                    }
                } else {
                    result.innerHTML = `<p class="success">${tableName}: Found ${data.length} records</p>`;
                    if (data.length > 0) {
                        result.innerHTML += `<pre>${JSON.stringify(data[0], null, 2)}</pre>`;
                    }
                }
            } catch (e) {
                result.innerHTML = `<p class="error">Exception: ${e.message}</p>`;
            }
        }

        async function createTestStats() {
            const result = document.getElementById('create-result');
            result.innerHTML = '<p>Creating test stats...</p>';
            
            try {
                const { data, error } = await window.supabase
                    .from('dashboard_stats')
                    .insert([{
                        total_members: 5,
                        monthly_events: 3,
                        matching_success: 10,
                        unread_messages: 2
                    }])
                    .select();
                
                if (error) {
                    result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                } else {
                    result.innerHTML = `<p class="success">Stats created!</p>`;
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (e) {
                result.innerHTML = `<p class="error">Exception: ${e.message}</p>`;
            }
        }

        async function createTestEvent() {
            const result = document.getElementById('create-result');
            result.innerHTML = '<p>Creating test event...</p>';
            
            try {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const { data, error } = await window.supabase
                    .from('events')
                    .insert([{
                        title: 'テストイベント ' + Date.now(),
                        description: 'これはテストイベントです',
                        event_date: tomorrow.toISOString().split('T')[0],
                        time: '15:00-17:00',
                        location: 'オンライン'
                    }])
                    .select();
                
                if (error) {
                    result.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                    result.innerHTML += `<pre>${JSON.stringify(error, null, 2)}</pre>`;
                } else {
                    result.innerHTML = `<p class="success">Event created!</p>`;
                    result.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (e) {
                result.innerHTML = `<p class="error">Exception: ${e.message}</p>`;
            }
        }

        // Auto check on load
        window.addEventListener('supabaseReady', () => {
            console.log('Supabase ready');
            checkAuth();
        });
        
        // Also check after a delay
        setTimeout(() => {
            if (window.supabase) checkAuth();
        }, 1000);
    </script>
</body>
</html>