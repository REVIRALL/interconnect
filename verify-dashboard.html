<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Verification</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .data-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        pre { background: #f4f4f4; padding: 10px; overflow: auto; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .highlight { background: yellow; }
    </style>
</head>
<body>
    <h1>Dashboard Verification</h1>
    
    <div class="status info">
        <h3>Instructions:</h3>
        <ol>
            <li>Open the dashboard at <a href="https://interconnect-auto-test.netlify.app/dashboard.html" target="_blank">https://interconnect-auto-test.netlify.app/dashboard.html</a></li>
            <li>Click "Verify Dashboard Data" below to check if real data is being displayed</li>
            <li>Check the results to see what data is actually showing</li>
        </ol>
    </div>

    <button onclick="verifyDashboard()">Verify Dashboard Data</button>
    <button onclick="insertTestData()">Insert Test Data</button>

    <div id="results"></div>

    <script src="js/supabase-client.js"></script>
    <script>
        async function verifyDashboard() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            // Check auth
            const authStatus = await checkAuth();
            addResult('Authentication', authStatus.success, authStatus.message, authStatus.data);

            // Check dashboard stats
            const statsStatus = await checkDashboardStats();
            addResult('Dashboard Stats', statsStatus.success, statsStatus.message, statsStatus.data);

            // Check activities
            const activitiesStatus = await checkActivities();
            addResult('Recent Activities', activitiesStatus.success, activitiesStatus.message, activitiesStatus.data);

            // Check events
            const eventsStatus = await checkEvents();
            addResult('Upcoming Events', eventsStatus.success, eventsStatus.message, eventsStatus.data);

            // Check UI elements
            checkUIElements();
        }

        async function checkAuth() {
            try {
                const { data: { user } } = await window.supabase.auth.getUser();
                if (user) {
                    return {
                        success: true,
                        message: `Authenticated as: ${user.email}`,
                        data: { userId: user.id, email: user.email }
                    };
                } else {
                    return {
                        success: false,
                        message: 'Not authenticated',
                        data: null
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function checkDashboardStats() {
            try {
                const { data, error } = await window.supabase
                    .from('dashboard_stats')
                    .select('*')
                    .single();

                if (error) throw error;

                return {
                    success: true,
                    message: 'Dashboard stats found',
                    data: {
                        totalMembers: data.total_members,
                        monthlyEvents: data.monthly_events,
                        matchingSuccess: data.matching_success,
                        unreadMessages: data.unread_messages,
                        lastUpdated: data.updated_at
                    }
                };
            } catch (error) {
                return {
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function checkActivities() {
            try {
                const { data, error } = await window.supabase
                    .from('user_activities')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                return {
                    success: true,
                    message: `Found ${data.length} activities`,
                    data: data.map(a => ({
                        type: a.activity_type,
                        description: a.activity_data?.description || 'No description',
                        created: a.created_at
                    }))
                };
            } catch (error) {
                return {
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        async function checkEvents() {
            try {
                const { data, error } = await window.supabase
                    .from('events')
                    .select('*')
                    .order('date', { ascending: true })
                    .limit(5);

                if (error) throw error;

                return {
                    success: true,
                    message: `Found ${data.length} events`,
                    data: data.map(e => ({
                        title: e.title,
                        date: e.date,
                        time: e.time,
                        location: e.location
                    }))
                };
            } catch (error) {
                return {
                    success: false,
                    message: `Error: ${error.message}`,
                    data: null
                };
            }
        }

        function checkUIElements() {
            const uiChecks = [
                { selector: '.stat-value', description: 'Stat Values' },
                { selector: '.activity-content', description: 'Activity Items' },
                { selector: '.event-details', description: 'Event Details' },
                { selector: '.notification-badge', description: 'Notification Badges' }
            ];

            const uiResults = document.createElement('div');
            uiResults.className = 'data-section';
            uiResults.innerHTML = '<h3>UI Elements Check</h3>';

            const iframe = document.createElement('iframe');
            iframe.src = 'dashboard.html';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);

            iframe.onload = () => {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                uiChecks.forEach(check => {
                    const elements = iframeDoc.querySelectorAll(check.selector);
                    const status = elements.length > 0 ? 'success' : 'warning';
                    const message = `${check.description}: Found ${elements.length} elements`;
                    
                    const div = document.createElement('div');
                    div.className = `status ${status}`;
                    div.textContent = message;
                    uiResults.appendChild(div);
                });

                document.body.removeChild(iframe);
                document.getElementById('results').appendChild(uiResults);
            };
        }

        async function insertTestData() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">Inserting test data...</div>';

            try {
                // Get current user
                const { data: { user } } = await window.supabase.auth.getUser();
                if (!user) {
                    throw new Error('Not authenticated');
                }

                // Insert/update dashboard stats
                const { data: statsData, error: statsError } = await window.supabase
                    .from('dashboard_stats')
                    .upsert({
                        id: 1,
                        total_members: 1234,
                        monthly_events: 15,
                        matching_success: 89,
                        unread_messages: 42,
                        member_growth_percentage: 12.0,
                        event_increase: 3,
                        matching_success_percentage: 23.0,
                        message_decrease_percentage: 5.0
                    });

                if (statsError) throw statsError;

                // Insert sample activities
                const activities = [
                    {
                        user_id: user.id,
                        activity_type: 'member_join',
                        activity_data: { 
                            description: '山田太郎さんがコミュニティに参加しました',
                            member_name: '山田太郎'
                        }
                    },
                    {
                        user_id: user.id,
                        activity_type: 'event_complete',
                        activity_data: {
                            description: '月例ネットワーキング会が成功裏に終了',
                            event_name: '月例ネットワーキング会'
                        }
                    }
                ];

                const { error: activitiesError } = await window.supabase
                    .from('user_activities')
                    .insert(activities);

                if (activitiesError) console.warn('Activities insert error:', activitiesError);

                resultsDiv.innerHTML = '<div class="status success">Test data inserted successfully! Refresh the dashboard to see the changes.</div>';
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="status error">Error inserting test data: ${error.message}</div>`;
            }
        }

        function addResult(title, success, message, data) {
            const div = document.createElement('div');
            div.className = 'data-section';
            div.innerHTML = `
                <h3>${title}</h3>
                <div class="status ${success ? 'success' : 'error'}">
                    ${message}
                </div>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            document.getElementById('results').appendChild(div);
        }

        // Auto-check when Supabase is ready
        window.addEventListener('supabaseReady', () => {
            console.log('Supabase ready for verification');
        });
    </script>
</body>
</html>